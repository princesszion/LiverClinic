<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physician Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-sparkline"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .metric-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            background-color: #f9f9f9;
            width: 250px;
        }
        .metric-title {
            font-weight: bold;
        }
        .critical {
            color: red;
        }
        .warning {
            color: orange;
        }
        .normal {
            color: green;
        }
        .sparkline {
            width: 100%;
            height: 50px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>Physician Dashboard</h2>
        <input type="text" id="patientId" placeholder="Enter Patient ID">
        <button onclick="loadPatientData()">Load Data</button>
        <div id="patient-metrics" class="d-flex flex-wrap"></div>
    </div>

    <script>
        function loadPatientData() {
            let patientId = document.getElementById("patientId").value;
            if (!patientId) return alert("Please enter a Patient ID");
            
            fetch(`/patient/${patientId}`)
                .then(response => response.json())
                .then(data => {
                    displayMetrics(data);
                })
                .catch(error => console.error("Error loading data:", error));
        }
        
        function displayMetrics(data) {
            let container = document.getElementById("patient-metrics");
            container.innerHTML = "";
            
            Object.keys(data).forEach(table => {
                let records = data[table];
                if (records.length > 0) {
                    let latest = records[records.length - 1]; // Get latest record
                    let card = document.createElement("div");
                    card.className = "metric-card";
                    
                    let html = `<div class='metric-title'>${table.replace('_', ' ')}</div>`;
                    Object.keys(latest).forEach(metric => {
                        if (metric !== "PAT_MRN_ID" && metric !== "date") {
                            let value = latest[metric];
                            let status = value > 100 ? 'critical' : value > 50 ? 'warning' : 'normal';
                            html += `<div>${metric}: <span class='${status}'>${value}</span></div>`;
                        }
                    });
                    html += `<div class='sparkline' id='spark-${table}'></div>`;
                    
                    card.innerHTML = html;
                    container.appendChild(card);
                    
                    let trendData = records.map(r => r[Object.keys(r)[1]]); // First metric trend
                    setTimeout(() => {
                        $(`#spark-${table}`).sparkline(trendData, { type: 'line', width: '100%', height: '50px' });
                    }, 100);
                }
            });
        }
    </script>
</body>
</html>
